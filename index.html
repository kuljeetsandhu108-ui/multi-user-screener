<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Stock Screener</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        /* All CSS is correct and remains the same */
        body { font-family: 'Roboto', sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .container { display: grid; grid-template-columns: 2.5fr 1fr; gap: 20px; max-width: 1400px; margin: auto; }
        .card { background-color: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 15px; }
        .stock-name { font-size: 28px; font-weight: 700; }
        .stock-ticker { font-size: 16px; color: #666; }
        .price-info { text-align: right; }
        .price { font-size: 36px; font-weight: 500; }
        .change { font-size: 18px; font-weight: 500; margin-left: 10px; }
        .positive { color: #26a69a; }
        .negative { color: #ef5350; }
        .search-container { width: 100%; margin-top: 20px; display: flex; gap: 10px; }
        .search-input { width: 100%; padding: 12px 15px; font-size: 16px; border: 1px solid #ddd; border-radius: 6px; outline: none; }
        .search-input:focus { border-color: #4285F4; }
        .search-button { padding: 12px 25px; font-size: 16px; font-weight: 500; background-color: #4285F4; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
        .search-button:hover { background-color: #357ae8; }
        .search-button:disabled { background-color: #9e9e9e; cursor: not-allowed; }
        .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; margin-top: 20px; }
        .metric { display: flex; justify-content: space-between; align-items: center; font-size: 15px; }
        .metric-label { color: #666; }
        .metric-value { font-weight: 500; }
        .loader { text-align: center; padding: 100px; font-size: 20px; font-weight: 500; color: #666; }
        .hidden { display: none; }
        #meter_div { width: 100%; height: 180px; }
        .rsi-oversold { color: #2e7d32; font-weight: 700; }
        .rsi-overbought { color: #c62828; font-weight: 700; }
        .rsi-neutral { color: #333; }
        .interpretation { font-size: 12px; font-style: italic; text-align: right; }
        .scan-passed { color: #2e7d32; font-weight: 700; }
        .scan-failed { color: #c62828; font-weight: 700; }
        .piotroski-strong { color: #2e7d32; }
        .piotroski-weak { color: #c62828; }
    </style>
</head>
<body>
    <div id="loader" class="loader">Loading Screener...</div>
    <div id="dashboardContent" class="container hidden">
        <div class="left-column">
             <div class="card">
                <div class="header">
                    <div><div id="stockName" class="stock-name">-</div><div id="stockTicker" class="stock-ticker">-</div></div>
                    <div class="price-info"><span id="stockPrice" class="price">-</span><span id="stockChange" class="change"></span></div>
                </div>
                <div class="search-container"><input type="text" id="tickerInput" class="search-input" placeholder="Enter Ticker (e.g., RELIANCE)"><button id="searchBtn" class="search-button">Search</button></div>
            </div>
            <div class="card" style="margin-top: 20px; height: 550px;"><div id="tradingview-widget-container" style="height: 100%; width: 100%;"></div></div>
        </div>
        <div class="right-column">
            <div class="card"><h4>Technical Summary</h4><div id="meter_div"></div></div>
            <div class="card" style="margin-top: 20px;">
                <h4>Key Metrics</h4>
                <div class="metrics-grid">
                    <div class="metric"><span class="metric-label">Open</span> <span id="openValue" class="metric-value">-</span></div>
                    <div class="metric"><span class="metric-label">High</span> <span id="highValue" class="metric-value">-</span></div>
                    <div class="metric"><span class="metric-label">Low</span> <span id="lowValue" class="metric-value">-</span></div>
                    <div class="metric"><span class="metric-label">Prev. Close</span> <span id="closeValue" class="metric-value">-</span></div>
                    <div class="metric"><span class="metric-label">Volume</span> <span id="volumeValue" class="metric-value">-</span></div>
                </div>
            </div>
            <div class="card" style="margin-top: 20px;">
                <h4>Technical Indicators</h4>
                <div class="metrics-grid">
                    <div class="metric"><span class="metric-label">RSI (14)</span> <span id="rsiValue" class="metric-value">-</span></div>
                    <div class="metric"><span></span> <span id="rsiInterp" class="interpretation"></span></div>
                    <div class="metric"><span class="metric-label">EMA (20)</span> <span id="ema20Value" class="metric-value">-</span></div>
                    <div class="metric"><span class="metric-label">EMA (50)</span> <span id="ema50Value" class="metric-value">-</span></div>
                </div>
            </div>
            <div class="card" style="margin-top: 20px;">
                <h4>Fundamental Scans</h4>
                <div class="metrics-grid" style="grid-template-columns: 1fr;">
                    <div class="metric"><span class="metric-label">Piotroski F-Score</span><span id="piotroskiValue" class="metric-value">- / 9</span></div>
                    <div class="metric"><span class="metric-label">Graham Scan</span><span id="grahamValue" class="metric-value">-</span></div>
                     <div class="metric"><span class="metric-label">FII Shareholding</span><span id="fiiValue" class="metric-value">- %</span></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // --- THIS IS THE FINAL, GUARANTEED CHART FUNCTION ---
        function loadTradingViewWidget(ticker) { // e.g., ticker is "TATASTEEL-EQ-NSE"
            const container = document.getElementById('tradingview-widget-container');
            if (!ticker || !container) return;
            container.innerHTML = '';
            
            // --- THE GUARANTEED FIX ---
            // 1. Get the base symbol by splitting at the hyphen and taking the first part.
            //    This correctly gets "TATASTEEL" from "TATASTEEL-EQ-NSE".
            const baseSymbol = ticker.split('-')[0];
            
            // 2. We already know the exchange is NSE from our backend logic.
            const exchange = "NSE";
            
            // 3. Create the final, clean symbol that TradingView always understands.
            const tradingViewSymbol = `${exchange}:${baseSymbol}`;
            // --- END OF FIX ---

            const script = document.createElement('script');
            script.src = 'https://s3.tradingview.com/tv.js';
            script.async = true;
            script.onload = () => {
                new TradingView.widget({
                    "autosize": true,
                    "symbol": tradingViewSymbol, // Use the final, clean symbol
                    "interval": "D",
                    "timezone": "Asia/Kolkata",
                    "theme": "light",
                    "style": "1",
                    "locale": "en",
                    "enable_publishing": false,
                    "allow_symbol_change": true,
                    "container_id": "tradingview-widget-container"
                });
            };
            container.appendChild(script);
        }

        // --- All other JavaScript functions remain the same ---
        // I have included them in full below to ensure there are no errors.
        function formatVolume(num) { if (!num || isNaN(num)) return '-'; if (num >= 10000000) return (num / 10000000).toFixed(2) + ' Cr'; if (num >= 100000) return (num / 100000).toFixed(2) + ' Lac'; if (num >= 1000) return (num / 1000).toFixed(2) + ' K'; return num.toString(); }
        function drawMeter(recommendation) { if (typeof google === 'undefined' || !google.visualization) return; let meterValue = 2; switch(recommendation) { case "Strong Sell": meterValue = 0; break; case "Sell": meterValue = 1; break; case "Neutral": meterValue = 2; break; case "Buy": meterValue = 3; break; case "Strong Buy": meterValue = 4; break; } const data = google.visualization.arrayToDataTable([['Label', 'Value'], [recommendation, meterValue]]); const options = { width: '100%', height: 180, redFrom: 0, redTo: 1.5, yellowFrom: 1.5, yellowTo: 2.5, greenFrom: 2.5, greenTo: 4, minorTicks: 4, min: 0, max: 4, animation: { duration: 500, easing: 'out' } }; const chart = new google.visualization.Gauge(document.getElementById('meter_div')); chart.draw(data, options); }
        function updateDashboard(data) {
            document.getElementById('stockName').textContent = data.name || data.ticker.split('-')[0];
            document.getElementById('stockTicker').textContent = data.ticker;
            document.getElementById('stockPrice').textContent = data.price ? `â‚¹${data.price.toFixed(2)}` : '-';
            const changeElement = document.getElementById('stockChange');
            if (data.change && data.changePct) {
                const changeText = `${data.change.toFixed(2)} (${data.changePct.toFixed(2)}%)`;
                changeElement.textContent = changeText;
                changeElement.className = data.change >= 0 ? 'change positive' : 'change negative';
            } else { changeElement.textContent = ''; }
            document.getElementById('openValue').textContent = data.open ? data.open.toFixed(2) : '-';
            document.getElementById('highValue').textContent = data.high ? data.high.toFixed(2) : '-';
            document.getElementById('lowValue').textContent = data.low ? data.low.toFixed(2) : '-';
            document.getElementById('closeValue').textContent = data.close ? data.close.toFixed(2) : '-';
            document.getElementById('volumeValue').textContent = formatVolume(data.volume);

            const rsiValueEl = document.getElementById('rsiValue');
            const rsiInterpEl = document.getElementById('rsiInterp');
            if (data.rsi) {
                rsiValueEl.textContent = data.rsi.toFixed(2);
                if (data.rsi > 70) { rsiValueEl.className = 'metric-value rsi-overbought'; rsiInterpEl.textContent = 'Overbought'; }
                else if (data.rsi < 30) { rsiValueEl.className = 'metric-value rsi-oversold'; rsiInterpEl.textContent = 'Oversold'; }
                else { rsiValueEl.className = 'metric-value rsi-neutral'; rsiInterpEl.textContent = 'Neutral'; }
            } else { rsiValueEl.textContent = '-'; rsiInterpEl.textContent = ''; }
            document.getElementById('ema20Value').textContent = data.ema20 ? data.ema20.toFixed(2) : '-';
            document.getElementById('ema50Value').textContent = data.ema50 ? data.ema50.toFixed(2) : '-';
            
            drawMeter(data.recommendation);

            const piotroskiEl = document.getElementById('piotroskiValue');
            if (data.piotroskiFScore !== null) {
                piotroskiEl.textContent = `${data.piotroskiFScore} / 9`;
                if (data.piotroskiFScore >= 7) { piotroskiEl.className = 'metric-value piotroski-strong'; }
                else if (data.piotroskiFScore <= 3) { piotroskiEl.className = 'metric-value piotroski-weak'; }
                else { piotroskiEl.className = 'metric-value'; }
            } else { piotroskiEl.textContent = 'N/A'; }

            const grahamEl = document.getElementById('grahamValue');
            if (data.grahamScanPassed !== null) {
                grahamEl.textContent = data.grahamScanPassed ? 'Pass' : 'Fail';
                grahamEl.className = data.grahamScanPassed ? 'metric-value scan-passed' : 'metric-value scan-failed';
            } else { grahamEl.textContent = 'N/A'; }

            const fiiEl = document.getElementById('fiiValue');
            if (data.fiiPercentage !== null) {
                fiiEl.textContent = `${(data.fiiPercentage).toFixed(2)} %`;
            } else { fiiEl.textContent = 'N/A'; }
        }
        async function searchStock(ticker) { const searchButton = document.getElementById('searchBtn'); if (!ticker) { alert('Please enter a stock ticker.'); return; } searchButton.disabled = true; searchButton.textContent = 'Loading...'; const isFirstLoad = document.getElementById('dashboardContent').classList.contains('hidden'); if (isFirstLoad) { document.getElementById('loader').classList.remove('hidden'); } try { const apiUrl = `/api/stock-data?ticker=${ticker.toUpperCase()}`; const response = await fetch(apiUrl); const data = await response.json(); if (!response.ok || data.error) { throw new Error(data.details || 'Stock not found or API error.'); } updateDashboard(data); loadTradingViewWidget(data.ticker); if (isFirstLoad) { document.getElementById('loader').classList.add('hidden'); document.getElementById('dashboardContent').classList.remove('hidden'); } } catch (error) { alert(`Error: ${error.message}`); if (isFirstLoad) { document.getElementById('loader').classList.add('hidden'); document.getElementById('dashboardContent').classList.remove('hidden'); } } finally { searchButton.disabled = false; searchButton.textContent = 'Search'; } }
        google.charts.load('current', {'packages':['gauge']});
        google.charts.setOnLoadCallback(runApplication);
        function runApplication() { const searchButton = document.getElementById('searchBtn'); const tickerInput = document.getElementById('tickerInput'); searchButton.addEventListener('click', () => { searchStock(tickerInput.value); }); tickerInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') { searchStock(tickerInput.value); } }); searchStock('RELIANCE'); }
    </script>
</body>
</html>
