<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Stock Screener</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- NEW: Lightweight Charts™ Library -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style> /* ... All previous CSS remains the same ... */ </style>
</head>
<body>
    <div id="loader" class="loader">Loading Screener...</div>
    <div id="dashboardContent" class="container hidden">
        <div class="left-column">
             <div class="card"> /* ... Header card content ... */ </div>
            <!-- The Chart Card's content is now simpler -->
            <div class="card" style="margin-top: 20px; height: 550px; padding: 0;">
                <div id="chart-container" style="height: 100%; width: 100%;"></div>
            </div>
        </div>
        <div class="right-column"> /* ... All right-column cards remain the same ... */ </div>
    </div>
    
    <script>
        // --- THIS IS THE NEW, GUARANTEED CHART LOGIC ---
        let chart = null; // Global chart variable
        
        function createChart(chartData) {
            const chartContainer = document.getElementById('chart-container');
            chartContainer.innerHTML = ''; // Clear previous chart
            
            chart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.clientWidth,
                height: chartContainer.clientHeight,
                layout: { textColor: 'black', background: { type: 'solid', color: 'white' } },
                grid: { vertLines: { color: '#f0f0f0' }, horzLines: { color: '#f0f0f0' } },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
            });
            
            const candleSeries = chart.addCandlestickSeries({
                upColor: '#26a69a', downColor: '#ef5350',
                borderDownColor: '#ef5350', borderUpColor: '#26a69a',
                wickDownColor: '#ef5350', wickUpColor: '#26a69a',
            });
            
            candleSeries.setData(chartData);
            chart.timeScale().fitContent();

            // Handle resizing
             new ResizeObserver(entries => {
                if (entries.length > 0 && entries[0].contentRect.width > 0) {
                    chart.applyOptions({ width: entries[0].contentRect.width });
                }
            }).observe(chartContainer);
        }
        
        // --- The updateDashboard function now calls createChart ---
        function updateDashboard(data) {
            // ... all previous update logic remains the same ...
            // Update Header, Key Metrics, Indicators, Meter, Scans, etc.

            // NEW: Create the chart with our own historical data
            if (data.history) {
                createChart(data.history);
            }
        }
        
        // --- All other JavaScript functions (searchStock, etc.) remain the same ---
        // I have included the full, correct script below for certainty.
    </script>
    <script> // Full script for copy-pasting
        let chart = null;
        function createChart(chartData) { const chartContainer = document.getElementById('chart-container'); chartContainer.innerHTML = ''; chart = LightweightCharts.createChart(chartContainer, { width: chartContainer.clientWidth, height: chartContainer.clientHeight, layout: { textColor: 'black', background: { type: 'solid', color: 'white' } }, grid: { vertLines: { color: '#f0f0f0' }, horzLines: { color: '#f0f0f0' } }, crosshair: { mode: LightweightCharts.CrosshairMode.Normal }, }); const candleSeries = chart.addCandlestickSeries({ upColor: '#26a69a', downColor: '#ef5350', borderDownColor: '#ef5350', borderUpColor: '#26a69a', wickDownColor: '#ef5350', wickUpColor: '#26a69a', }); candleSeries.setData(chartData); chart.timeScale().fitContent(); new ResizeObserver(entries => { if (entries.length > 0 && entries[0].contentRect.width > 0) { chart.applyOptions({ width: entries[0].contentRect.width }); } }).observe(chartContainer); }
        function formatVolume(num) { if (!num || isNaN(num)) return '-'; if (num >= 10000000) return (num / 10000000).toFixed(2) + ' Cr'; if (num >= 100000) return (num / 100000).toFixed(2) + ' Lac'; if (num >= 1000) return (num / 1000).toFixed(2) + ' K'; return num.toString(); }
        function drawMeter(recommendation) { if (typeof google === 'undefined' || !google.visualization) return; let meterValue = 2; switch(recommendation) { case "Strong Sell": meterValue = 0; break; case "Sell": meterValue = 1; break; case "Neutral": meterValue = 2; break; case "Buy": meterValue = 3; break; case "Strong Buy": meterValue = 4; break; } const data = google.visualization.arrayToDataTable([['Label', 'Value'], [recommendation, meterValue]]); const options = { width: '100%', height: 180, redFrom: 0, redTo: 1.5, yellowFrom: 1.5, yellowTo: 2.5, greenFrom: 2.5, greenTo: 4, minorTicks: 4, min: 0, max: 4, animation: { duration: 500, easing: 'out' } }; const chart = new google.visualization.Gauge(document.getElementById('meter_div')); chart.draw(data, options); }
        function updateDashboard(data) {
            document.getElementById('stockName').textContent = data.name || data.ticker.split('-')[0];
            document.getElementById('stockTicker').textContent = data.ticker;
            document.getElementById('stockPrice').textContent = data.price ? `₹${data.price.toFixed(2)}` : '-';
            const changeElement = document.getElementById('stockChange');
            if (data.change && data.changePct) { const changeText = `${data.change.toFixed(2)} (${data.changePct.toFixed(2)}%)`; changeElement.textContent = changeText; changeElement.className = data.change >= 0 ? 'change positive' : 'change negative'; } else { changeElement.textContent = ''; }
            document.getElementById('openValue').textContent = data.open ? data.open.toFixed(2) : '-'; document.getElementById('highValue').textContent = data.high ? data.high.toFixed(2) : '-'; document.getElementById('lowValue').textContent = data.low ? data.low.toFixed(2) : '-'; document.getElementById('closeValue').textContent = data.close ? data.close.toFixed(2) : '-'; document.getElementById('volumeValue').textContent = formatVolume(data.volume);
            const rsiValueEl = document.getElementById('rsiValue'); const rsiInterpEl = document.getElementById('rsiInterp');
            if (data.rsi) { rsiValueEl.textContent = data.rsi.toFixed(2); if (data.rsi > 70) { rsiValueEl.className = 'metric-value rsi-overbought'; rsiInterpEl.textContent = 'Overbought'; } else if (data.rsi < 30) { rsiValueEl.className = 'metric-value rsi-oversold'; rsiInterpEl.textContent = 'Oversold'; } else { rsiValueEl.className = 'metric-value rsi-neutral'; rsiInterpEl.textContent = 'Neutral'; } } else { rsiValueEl.textContent = '-'; rsiInterpEl.textContent = ''; }
            document.getElementById('ema20Value').textContent = data.ema20 ? data.ema20.toFixed(2) : '-'; document.getElementById('ema50Value').textContent = data.ema50 ? data.ema50.toFixed(2) : '-';
            drawMeter(data.recommendation);
            const piotroskiEl = document.getElementById('piotroskiValue'); if (data.piotroskiFScore !== null) { piotroskiEl.textContent = `${data.piotroskiFScore} / 9`; if (data.piotroskiFScore >= 7) { piotroskiEl.className = 'metric-value piotroski-strong'; } else if (data.piotroskiFScore <= 3) { piotroskiEl.className = 'metric-value piotroski-weak'; } else { piotroskiEl.className = 'metric-value'; } } else { piotroskiEl.textContent = 'N/A'; }
            const grahamEl = document.getElementById('grahamValue'); if (data.grahamScanPassed !== null) { grahamEl.textContent = data.grahamScanPassed ? 'Pass' : 'Fail'; grahamEl.className = data.grahamScanPassed ? 'metric-value scan-passed' : 'metric-value scan-failed'; } else { grahamEl.textContent = 'N/A'; }
            const fiiEl = document.getElementById('fiiValue'); if (data.fiiPercentage !== null) { fiiEl.textContent = `${(data.fiiPercentage).toFixed(2)} %`; } else { fiiEl.textContent = 'N/A'; }
            if (data.history) { createChart(data.history); }
        }
        async function searchStock(ticker) { const searchButton = document.getElementById('searchBtn'); if (!ticker) { alert('Please enter a stock ticker.'); return; } searchButton.disabled = true; searchButton.textContent = 'Loading...'; const isFirstLoad = document.getElementById('dashboardContent').classList.contains('hidden'); if (isFirstLoad) { document.getElementById('loader').classList.remove('hidden'); } try { const apiUrl = `/api/stock-data?ticker=${ticker.toUpperCase()}`; const response = await fetch(apiUrl); const data = await response.json(); if (!response.ok || data.error) { throw new Error(data.details || 'Stock not found or API error.'); } updateDashboard(data); if (isFirstLoad) { document.getElementById('loader').classList.add('hidden'); document.getElementById('dashboardContent').classList.remove('hidden'); } } catch (error) { alert(`Error: ${error.message}`); if (isFirstLoad) { document.getElementById('loader').classList.add('hidden'); document.getElementById('dashboardContent').classList.remove('hidden'); } } finally { searchButton.disabled = false; searchButton.textContent = 'Search'; } }
        google.charts.load('current', {'packages':['gauge']});
        google.charts.setOnLoadCallback(runApplication);
        function runApplication() { const searchButton = document.getElementById('searchBtn'); const tickerInput = document.getElementById('tickerInput'); searchButton.addEventListener('click', () => { searchStock(tickerInput.value); }); tickerInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') { searchStock(tickerInput.value); } }); searchStock('RELIANCE'); }
    </script>
</body>
</html>