<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Stock Screener</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; box-sizing: border-box; }
        .container { display: grid; grid-template-columns: 2.5fr 1fr; gap: 20px; max-width: 1400px; margin: auto; }
        .card { background-color: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 15px; }
        .stock-name { font-size: 28px; font-weight: 700; }
        .stock-ticker { font-size: 16px; color: #666; }
        .price-info { text-align: right; }
        .price { font-size: 36px; font-weight: 500; }
        .change { font-size: 18px; font-weight: 500; margin-left: 10px; }
        .positive { color: #26a69a; }
        .negative { color: #ef5350; }
        .search-container { width: 100%; margin-top: 20px; display: flex; gap: 10px; }
        .search-input { width: 100%; padding: 12px 15px; font-size: 16px; border: 1px solid #ddd; border-radius: 6px; outline: none; }
        .search-button { padding: 12px 25px; font-size: 16px; font-weight: 500; background-color: #4285F4; color: white; border: none; border-radius: 6px; cursor: pointer; }
        .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; margin-top: 20px; }
        .metric { display: flex; justify-content: space-between; align-items: center; font-size: 15px; }
        .metric-label { color: #666; }
        .metric-value { font-weight: 500; }
        .loader { text-align: center; padding: 100px; font-size: 20px; font-weight: 500; color: #666; }
        .hidden { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #f0f0f0; }
        th { color: #666; font-weight: 500; }
        .pivot-table td, .pivot-table th { text-align: center; }
        .pivot-table th:first-child, .pivot-table td:first-child { text-align: left; font-weight: 700; }
        .pivot-table td:nth-child(5) { background-color: #f8f9fa; font-weight: 700; }
        #meter_div { width: 100%; height: 180px; }
        .indicator-table td:nth-child(2) { font-weight: 500; }
        .indicator-table td:nth-child(3) { text-align: right; font-weight: 700; }
        .indication-bearish { color: #ef5350; }
        .indication-bullish { color: #26a69a; }
        .indication-neutral { color: #333; }
    </style>
</head>
<body>
    <div id="loader" class="loader">Loading Screener...</div>
    <div id="dashboardContent" class="container hidden">
        <div class="left-column">
            <div class="card">
                <div class="header">
                    <div><div id="stockName" class="stock-name">-</div><div id="stockTicker" class="stock-ticker">-</div></div>
                    <div class="price-info"><span id="stockPrice" class="price">-</span><span id="stockChange" class="change"></span></div>
                </div>
                <div class="search-container"><input type="text" id="tickerInput" class="search-input" placeholder="Enter Ticker (e.g., RELIANCE)"><button id="searchBtn" class="search-button">Search</button></div>
            </div>
            <div class="card" style="margin-top: 20px; height: 550px;"><canvas id="mainChart"></canvas></div>
            <div class="card" style="margin-top: 20px;">
                <h4>Pivot Levels</h4><table id="pivotTable" class="pivot-table"></table>
            </div>
        </div>
        <div class="right-column">
            <div class="card"><h4>Technical Summary</h4><div id="meter_div"></div></div>
            <div class="card" style="margin-top: 20px;">
                <h4>Key Metrics</h4>
                <div class="metrics-grid">
                    <div class="metric"><span class="metric-label">Open</span><span id="openValue">-</span></div>
                    <div class="metric"><span class="metric-label">High</span><span id="highValue">-</span></div>
                    <div class="metric"><span class="metric-label">Low</span><span id="lowValue">-</span></div>
                    <div class="metric"><span class="metric-label">Prev. Close</span><span id="closeValue">-</span></div>
                    <div class="metric"><span class="metric-label">Volume</span><span id="volumeValue">-</span></div>
                </div>
            </div>
            <div class="card" style="margin-top: 20px;">
                <h4>Technical Indicators</h4><table id="indicatorTable" class="indicator-table"></table>
            </div>
            <div class="card" style="margin-top: 20px;"><h4>Fundamental Scans</h4><div id="fundamentalDiv">N/A</div></div>
        </div>
    </div>
    
    <script>
        const UI = {
            loader: document.getElementById('loader'), dashboard: document.getElementById('dashboardContent'),
            stockName: document.getElementById('stockName'), stockTicker: document.getElementById('stockTicker'),
            stockPrice: document.getElementById('stockPrice'), stockChange: document.getElementById('stockChange'),
            openValue: document.getElementById('openValue'), highValue: document.getElementById('highValue'),
            lowValue: document.getElementById('lowValue'), closeValue: document.getElementById('closeValue'),
            volumeValue: document.getElementById('volumeValue'), searchBtn: document.getElementById('searchBtn'),
            tickerInput: document.getElementById('tickerInput'), pivotTable: document.getElementById('pivotTable'),
            indicatorTable: document.getElementById('indicatorTable'),
            fundamentalDiv: document.getElementById('fundamentalDiv'),
            meterContainer: document.getElementById('meter_div'),
        };
        let mainChart = null;

        function formatVal(val, places = 2) {
            if (val === null || val === undefined) return 'N/A';
            return Number(val).toFixed(places);
        }

        function populateIndicatorTable(indicators) {
            const table = UI.indicatorTable;
            table.innerHTML = `<tr><th>Indicator</th><th>Level</th><th>Indication</th></tr>`;
            const createRow = (name, val, ind, cls) => { table.insertRow().innerHTML = `<td>${name}</td><td>${formatVal(val)}</td><td class="${cls}">${ind}</td>`; };
            if (indicators.rsi) createRow('RSI(14)', indicators.rsi, indicators.rsi > 70 ? 'Overbought' : indicators.rsi < 30 ? 'Oversold' : 'Neutral', indicators.rsi > 70 ? 'indication-bearish' : indicators.rsi < 30 ? 'indication-bullish' : 'indication-neutral');
        }

        function populatePivotTable(pivots) {
            const table = UI.pivotTable;
            table.innerHTML = `<tr><th>Type</th><th>R3</th><th>R2</th><th>R1</th><th>PP</th><th>S1</th><th>S2</th><th>S3</th></tr>`;
            if (!pivots) return;
            const createRow = (name, p) => {
                if (!p) return;
                table.insertRow().innerHTML = `<td>${name}</td><td>${formatVal(p.r3)}</td><td>${formatVal(p.r2)}</td><td>${formatVal(p.r1)}</td><td><b>${formatVal(p.pp)}</b></td><td>${formatVal(p.s1)}</td><td>${formatVal(p.s2)}</td><td>${formatVal(p.s3)}</td>`;
            };
            createRow('Classic', pivots.classic);
            createRow('Fibonacci', pivots.fibonacci);
            createRow('Camarilla', pivots.camarilla);
        }

        function updateUI(marketData, analysisData) {
            UI.stockName.textContent = marketData.name;
            UI.stockTicker.textContent = marketData.ticker;
            UI.stockPrice.textContent = `â‚¹${formatVal(marketData.price)}`;
            UI.stockChange.textContent = `${formatVal(marketData.change)} (${formatVal(marketData.changePct)}%)`;
            UI.stockChange.className = marketData.change >= 0 ? 'change positive' : 'change negative';
            UI.openValue.textContent = formatVal(marketData.open);
            UI.highValue.textContent = formatVal(marketData.high);
            UI.lowValue.textContent = formatVal(marketData.low);
            UI.closeValue.textContent = formatVal(marketData.close);
            UI.volumeValue.textContent = `${(marketData.volume / 10000000).toFixed(2)} Cr`;
            
            const chartData = marketData.history.map(d => ({ x: new Date(d.time).getTime(), o: d.open, h: d.high, l: d.low, c: d.close }));
            mainChart.data.datasets[0].data = chartData;
            mainChart.update();

            if (analysisData.indicators) populateIndicatorTable(analysisData.indicators);
            if (analysisData.pivots) populatePivotTable(analysisData.pivots);
            
            // Placeholder for other analysis UI updates
            // UI.fundamentalDiv.innerHTML = `...`;
            // drawMeter(analysisData.recommendation);
        }

        async function fullSearch(ticker) {
            UI.searchBtn.disabled = true;
            UI.searchBtn.textContent = 'Loading...';
            try {
                const marketRes = await fetch(`/api/market-data?ticker=${ticker.toUpperCase()}`);
                const marketData = await marketRes.json();
                if (!marketRes.ok) throw new Error(marketData.details || 'Market data error');
                
                updateUI(marketData, {}); // Update with market data first

                const analysisRes = await fetch(`/api/analysis-data?ticker=${ticker.toUpperCase()}&price=${marketData.price}`);
                const analysisData = await analysisRes.json();
                if (!analysisRes.ok) console.warn("Could not fetch analysis data:", analysisData.details);

                // Update again with the full data
                updateUI(marketData, analysisData);

            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                UI.searchBtn.disabled = false;
                UI.searchBtn.textContent = 'Search';
            }
        }

        function initializeApp() {
            UI.loader.classList.add('hidden');
            UI.dashboard.classList.remove('hidden');
            
            const ctx = document.getElementById('mainChart').getContext('2d');
            mainChart = new Chart(ctx, {
                type: 'candlestick',
                data: { datasets: [{ data: [] }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day' } } } }
            });
            
            UI.searchBtn.addEventListener('click', () => fullSearch(UI.tickerInput.value));
            UI.tickerInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') fullSearch(UI.tickerInput.value); });
            
            fullSearch('RELIANCE');
        }
        
        // This structure is correct and will not cause a race condition.
        google.charts.load('current', { 'packages': ['gauge'] });
        google.charts.setOnLoadCallback(initializeApp);
    </script>
</body>
</html>